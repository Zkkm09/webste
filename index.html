<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>واجهة عربية</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="./static/style.css">
</head>
<body>

<header>
  <div class="logo"><img src="./images/logo.png" alt="الشعار"></div>
  <div class="search">
  <i class="fas fa-search" id="searchToggle"></i>
  <input type="text" id="searchInput" placeholder="ابحث عن المنتجات...">
  <i class="fas fa-sliders-h" id="filterToggle" title="فلترة"></i>
  </div>

</header>

<main>
  <section id="home" class="page active">
    <div class="categories">
      <div class="category active" data-category="all">
        <img src="./images/Untitled design (16).png" alt="الكل"><span>الكل</span>
      </div>
      <div class="category" data-category="electronics">
        <img src="./images/Untitled design (17).png" alt="الكترونيات"><span>الكترونيات</span>
      </div>
      <div class="category" data-category="clothes">
        <img src="https://via.placeholder.com/80" alt="ملابس"><span>ملابس</span>
      </div>
      <div class="category" data-category="kitchen">
        <img src="https://via.placeholder.com/80" alt="مطبخ"><span>مطبخ</span>
      </div>
      <div class="category" data-category="kitchen">
        <img src="https://via.placeholder.com/80" alt="مطبخ"><span>مطبخ</span>
      </div>
      <div class="category" data-category="kitchen">
        <img src="https://via.placeholder.com/80" alt="مطبخ"><span>مطبخ</span>
      </div>
    </div>

    <hr class="divider">

    <div class="products">
      <div class="product" data-category="electronics">
        <img src="./images/logo.png" alt="هاتف ذكي">
        <div class="title-wrapper">
          <span class="title">هاتف ذكي</span>
          <div class="price-cart">
            <span class="price">250$</span>
            <div class="cart-btn"><i class="fas fa-cart-plus"></i></div>
          </div>
        </div>
        <span class="description">هاتف ذكي عالي الجودة مع شاشة 6.5 بوصة.</span>
      </div>
      <div class="product" data-category="clothes">
        <img src="./images/Untitled design (16).png" alt="قميص">
        <div class="title-wrapper">
          <span class="title">قميص</span>
          <div class="price-cart">
            <span class="price">35$</span>
            <div class="cart-btn"><i class="fas fa-cart-plus"></i></div>
          </div>
        </div>
        <span class="description">قميص قطني مريح للارتداء اليومي.</span>
      </div>
      <div class="product" data-category="kitchen">
        <img src="./images/Untitled design (17).png" alt="خلاط">
        <div class="title-wrapper">
          <span class="title">خلاط</span>
          <div class="price-cart">
            <span class="price">60$</span>
            <div class="cart-btn"><i class="fas fa-cart-plus"></i></div>
          </div>
        </div>
        <span class="description">خلاط كهربائي متعدد السرعات مع كوب زجاجي.</span>
      </div>
    </div>
  </section>

  <section id="cart" class="page">
    <h2>🛒 السلة</h2>
    <div class="cart-container" id="cartContainer"></div>

    <div class="form-group">
      <label for="userLocation">موقعك:</label>
      <div class="input-btn">
        <input type="text" id="userLocation" placeholder="أدخل موقعك أو استخدم موقعي">
        <button id="getLocationBtn">موقعي</button>
      </div>
    </div>

    <div class="form-group coupon-group">
  <label for="couponCode">كود الخصم:</label>
  <div class="input-btn">
    <input type="text" id="couponCode" placeholder="أدخل الكود">
    <button id="applyCouponBtn">تطبيق</button>
  </div>
  <div id="activeCoupon">
    <span id="activeCouponText"></span>
    <i class="fas fa-times" id="removeCoupon"></i>
  </div>
</div>



    <div class="form-group">
      <label for="userPhone">رقم الهاتف:</label>
      <input type="tel" id="userPhone" placeholder="07XXXXXXXX">
    </div>

    <div class="form-group">
      <label for="orderNotes">ملاحظات:</label>
      <textarea id="orderNotes" placeholder="أدخل ملاحظاتك"></textarea>
    </div>

    <div class="form-group">
      <label>طريقة التوصيل:</label>
      <div class="delivery-options">
        <div class="delivery-btn active" data-fee="5"><div> توصيل</div><small>5$</small></div>
        <div class="delivery-btn" data-fee="0"><div>استلام</div><small></small></div>
      </div>
    </div>

    <div class="cart-summary">
      <div><span>المجموع الفرعي (قبل الخصم):</span><span id="originalSubtotal">0$</span></div>
      <div><span>الخصم:</span><span id="discountAmount">0$</span></div>
      <div><span>المجموع الفرعي (بعد الخصم):</span><span id="subtotalPrice">0$</span></div>
      <div><span>رسوم التوصيل:</span><span id="deliveryFee">0$</span></div>
      <div class="total"><span>الإجمالي:</span><span id="totalPrice">0$</span></div>
    </div>

    <button class="checkout-btn" id="checkoutBtn">الانتقال للدفع</button>
  </section>

  <section id="profile" class="page">
    <h2>👤 معلوماتي</h2>
    <p>هذه هي صفحتك الشخصية.</p>
  </section>
</main>

<div id="filterOverlay" class="filter-overlay">
  <div class="filter-panel">
    <span id="filterClose" class="close-btn">&times;</span>
    <h3>فلترة المنتجات</h3>
    <div class="filter-group">
      <label>السعر من:</label>
      <input type="number" id="minPrice" placeholder="من">
      <label>إلى:</label>
      <input type="number" id="maxPrice" placeholder="إلى">
    </div>
    <div class="filter-group">
      <label>ترتيب حسب:</label>
      <select id="sortOrder">
        <option value="none">افتراضي</option>
        <option value="asc">الأقل سعرًا</option>
        <option value="desc">الأعلى سعرًا</option>
      </select>
    </div>
    <button id="applyFilterBtn">تطبيق الفلاتر</button>
  </div>
</div>


<nav>
  <div class="nav-item active" data-target="home"><div class="icon"><i class="fas fa-home"></i></div><span>الرئيسية</span></div>
  <div class="nav-item" data-target="cart">
    <div class="icon">
      <i class="fas fa-shopping-cart"></i>
      <span id="cartBadge">0</span>
    </div>
    <span>السلة</span>
  </div>
  <div class="nav-item" data-target="profile"><div class="icon"><i class="fas fa-user"></i></div><span>معلوماتي</span></div>
</nav>

<div class="product-popup-overlay" id="productPopupOverlay">
  <div class="product-popup">
    <span class="close-btn" id="popupClose">&times;</span>
    <img src="" alt="product" id="popupImg">
    <span id="popupTitle"></span>
    <span class="description" id="popupDesc"></span>
    <span class="price" id="popupPrice"></span>

    <div class="form-group">
  <label>الكمية:</label>
  <div class="quantity">
    <button class="qty-btn minus" id="popupMinus">-</button>
    <span id="popupQty">1</span>
    <button class="qty-btn plus" id="popupPlus">+</button>
  </div>
</div>


    <button id="popupAddCart">اضف للسلة</button>
  </div>
</div>

<div id="toast"></div>

<script>
/* ==============================
   📍 Location Section
================================= */
const getLocationBtn = document.getElementById("getLocationBtn");
const userLocationInput = document.getElementById("userLocation");

getLocationBtn.addEventListener("click", () => {
  if (navigator.geolocation) {
    getLocationBtn.disabled = true;
    getLocationBtn.innerText = "جاري تحديد الموقع...";
    navigator.geolocation.getCurrentPosition(
      (position) => {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        const mapsLink = `https://www.google.com/maps?q=${lat},${lng}`;
        userLocationInput.value = mapsLink;
        showToast("تم تحديد موقعك بنجاح ✔️");
        getLocationBtn.disabled = false;
        getLocationBtn.innerText = "📍 موقعي";
      },
      () => {
        alert("لم نتمكن من تحديد موقعك. يرجى تفعيل خدمات الموقع.");
        getLocationBtn.disabled = false;
        getLocationBtn.innerText = "📍 موقعي";
      }
    );
  } else {
    alert("متصفحك لا يدعم ميزة تحديد الموقع.");
  }
});

/* ==============================
   🧭 Navbar Section
================================= */
const navItems = document.querySelectorAll(".nav-item");
const pages = document.querySelectorAll(".page");
navItems.forEach(item => {
  item.addEventListener("click", () => {
    navItems.forEach(i => i.classList.remove("active"));
    pages.forEach(p => p.classList.remove("active"));
    item.classList.add("active");
    document.getElementById(item.dataset.target).classList.add("active");
  });
});

/* ==============================
   🏷 Categories Filter
================================= */
const categories = document.querySelectorAll(".category");
const products = document.querySelectorAll(".product");
categories.forEach(cat => {
  cat.addEventListener("click", () => {
    categories.forEach(c => c.classList.remove("active"));
    cat.classList.add("active");
    const selected = cat.dataset.category;
    products.forEach(p => p.style.display = (selected==='all'||p.dataset.category===selected)?'block':'none');
  });
});

/* ==============================
   🛒 Cart Section
================================= */
const cartContainer = document.getElementById("cartContainer");
const subtotalPriceEl = document.getElementById("subtotalPrice");
const deliveryFeeEl = document.getElementById("deliveryFee");
const totalPriceEl = document.getElementById("totalPrice");
const deliveryBtns = document.querySelectorAll(".delivery-btn");
let selectedDeliveryFee = 5;
let cart = [];
let discountPercent = 0;

function updateCart() {
  cartContainer.innerHTML = '';
  let subtotal = 0;

  // Update product buttons
  products.forEach(product => {
    const title = product.querySelector(".title").innerText;
    const cartBtn = product.querySelector(".cart-btn");
    const inCart = cart.find(i => i.title === title);
    cartBtn.style.background = inCart ? "green" : "var(--color-primary)";
  });

  // Render cart items
  cart.forEach((item,index) => {
    const itemTotal = item.qty * item.price;
    subtotal += itemTotal;
    const cartItem = document.createElement('div');
    cartItem.className = 'cart-item';
    cartItem.innerHTML = `
      <button class="remove-btn">&times;</button>
      <img src="${item.img}" alt="${item.title}">
      <div class="cart-details">
        <span class="cart-title">${item.title}</span>
        <div class="cart-qty-price">
          <div class="quantity">
            <button class="qty-btn minus">-</button>
            <input type="number" value="${item.qty}" min="1">
            <button class="qty-btn plus">+</button>
          </div>
          <span class="cart-price">${itemTotal}$</span>
        </div>
      </div>
    `;
    const qtyInput = cartItem.querySelector("input");
    const minusBtn = cartItem.querySelector(".minus");
    const plusBtn = cartItem.querySelector(".plus");
    const removeBtn = cartItem.querySelector(".remove-btn");

    minusBtn.addEventListener("click", () => { if(item.qty>1){ item.qty--; updateCart(); } });
    plusBtn.addEventListener("click", () => { item.qty++; updateCart(); });
    qtyInput.addEventListener("change", () => { item.qty = parseInt(qtyInput.value)||1; updateCart(); });

    removeBtn.addEventListener("click", () => {
      if(confirm(`هل أنت متأكد من إزالة "${item.title}" من السلة؟`)){
        cart.splice(index, 1);
        updateCart();
      }
    });

    cartContainer.appendChild(cartItem);
  });

// Apply discount
const discountAmount = subtotal * (discountPercent / 100);
const discountedSubtotal = subtotal - discountAmount;

// Update totals
document.getElementById("originalSubtotal").innerText = subtotal.toFixed(2) + "$";
document.getElementById("discountAmount").innerText = discountAmount.toFixed(2) + "$";
subtotalPriceEl.innerText = discountedSubtotal.toFixed(2) + "$";
deliveryFeeEl.innerText = selectedDeliveryFee + "$";
totalPriceEl.innerText = (discountedSubtotal + selectedDeliveryFee).toFixed(2) + "$";

  // Update cart badge
  const cartBadge = document.getElementById("cartBadge");
  const totalItems = cart.reduce((sum, item) => sum + item.qty, 0);
cartBadge.innerText = totalItems;
cartBadge.style.display = totalItems > 0 ? "inline-block" : "none";

// Pop animation
cartBadge.classList.remove("pop");
void cartBadge.offsetWidth; // trigger reflow
cartBadge.classList.add("pop");

}

/* ==============================
   🎟 Coupon Section (one active at a time)
================================= */
const couponInput = document.getElementById("couponCode");
const applyCouponBtn = document.getElementById("applyCouponBtn");
const activeCouponBox = document.getElementById("activeCoupon");
const activeCouponText = document.getElementById("activeCouponText");
const removeCouponBtn = document.getElementById("removeCoupon");

applyCouponBtn.addEventListener("click", () => {
  const code = couponInput.value.trim().toUpperCase();

  // Reset first (only one active coupon allowed)
  discountPercent = 0;
  activeCouponBox.style.display = "none";

  if (code === "TEST10") {
    discountPercent = 10;
    activeCouponText.innerText = `تم تفعيل الكوبون (${code}) - خصم 10%`;
    activeCouponBox.style.display = "flex";
    showToast("تم تطبيق كود الخصم 10% ✔️");
  } else if (code === "TEST20") {
    discountPercent = 20;
    activeCouponText.innerText = `تم تفعيل الكوبون (${code}) - خصم 20%`;
    activeCouponBox.style.display = "flex";
    showToast("تم تطبيق كود الخصم 20% ✔️");
  } else {
    showToast("كود الخصم غير صالح ❌");
  }

  couponInput.value = ""; // clear input
  updateCart();
});

// ❌ Remove coupon
removeCouponBtn.addEventListener("click", () => {
  discountPercent = 0;
  activeCouponBox.style.display = "none";
  updateCart();
  showToast("تم إلغاء الكوبون ❌");
});





/* ==============================
   🚚 Delivery Section
================================= */
deliveryBtns.forEach(btn => {
  btn.addEventListener("click", () => {
    deliveryBtns.forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    selectedDeliveryFee = parseFloat(btn.dataset.fee);
    updateCart();
  });
});

/* ==============================
   🛍 Product Popup
================================= */
const popupOverlay = document.getElementById("productPopupOverlay");
const popupImg = document.getElementById("popupImg");
const popupTitle = document.getElementById("popupTitle");
const popupDesc = document.getElementById("popupDesc");
const popupPrice = document.getElementById("popupPrice");
const popupClose = document.getElementById("popupClose");
const popupAddCart = document.getElementById("popupAddCart");

const popupQtyEl = document.getElementById("popupQty");
const popupMinus = document.getElementById("popupMinus");
const popupPlus = document.getElementById("popupPlus");

let popupQty = 1;

popupMinus.addEventListener("click", () => {
  if (popupQty > 1) popupQty--;
  popupQtyEl.innerText = popupQty;
});

popupPlus.addEventListener("click", () => {
  popupQty++;
  popupQtyEl.innerText = popupQty;
});

products.forEach(product => {
  const cartBtn = product.querySelector(".cart-btn");
  const price = parseFloat(product.querySelector(".price").innerText.replace("$",""));
  const title = product.querySelector(".title").innerText;
  const img = product.querySelector("img").src;

  product.addEventListener("click", e => {
    if(e.target.closest(".cart-btn")) return;

    popupImg.src = img;
    popupTitle.innerText = title;
    popupDesc.innerText = product.querySelector(".description").innerText;
    popupPrice.innerText = product.querySelector(".price").innerText;

    // Show current cart quantity if product is in cart
    const inCart = cart.find(i => i.title === title);
    if(inCart){
      popupQty = inCart.qty;
      popupAddCart.innerText = "تحديث السلة";
      popupAddCart.style.background = "green";
    } else {
      popupQty = 1;
      popupAddCart.innerText = "اضف للسلة";
      popupAddCart.style.background = ""; // default
    }

    popupQtyEl.innerText = popupQty;
    popupOverlay.classList.add("show");
  });

  cartBtn.addEventListener("click", e => {
    e.stopPropagation();
    const exists = cart.find(i => i.title === title);
    if(exists){ exists.qty++; } else { cart.push({title,img,price,qty:1}); }
    updateCart();
    showToast(title + " تمت إضافته للسلة ✔️");
  });
});

popupClose.addEventListener("click", () => popupOverlay.classList.remove("show"));
popupOverlay.addEventListener("click", e => { if(e.target === popupOverlay) popupOverlay.classList.remove("show"); });

popupAddCart.addEventListener("click", () => {
  const exists = cart.find(i => i.title === popupTitle.innerText);
  if (exists) {
    exists.qty = popupQty; // update to popup quantity
  } else {
    cart.push({
      title: popupTitle.innerText,
      img: popupImg.src,
      price: parseFloat(popupPrice.innerText.replace("$","")),
      qty: popupQty
    });
  }

  updateCart();
  popupOverlay.classList.remove("show");
  showToast(popupTitle.innerText + " تمت تحديثه/إضافته للسلة ✔️");

  // Reset popup
  popupQty = 1;
  popupQtyEl.innerText = "1";
  popupAddCart.innerText = "اضف للسلة";
  popupAddCart.style.background = "";
});

/* ==============================
   🔍 Search Section
================================= */
const searchToggle = document.getElementById("searchToggle");
const searchInput = document.getElementById("searchInput");
const searchContainer = document.querySelector("header .search");

searchToggle.addEventListener("click", () => {
  searchContainer.classList.toggle("active");
  if (searchContainer.classList.contains("active")) {
    searchInput.focus();
    searchToggle.classList.replace("fa-search", "fa-times");
  } else {
    searchInput.value = "";
    products.forEach(p => p.style.display = "block");
    searchToggle.classList.replace("fa-times", "fa-search");
  }
});

searchInput.addEventListener("input", () => {
  const query = searchInput.value.toLowerCase();
  products.forEach(p => {
    const title = p.querySelector('.title').innerText.toLowerCase();
    p.style.display = title.includes(query)?'block':'none';
  });
});
// Filter overlay logic
const filterToggle = document.getElementById("filterToggle");
const filterOverlay = document.getElementById("filterOverlay");
const filterClose = document.getElementById("filterClose");
const applyFilterBtn = document.getElementById("applyFilterBtn");
const minPriceInput = document.getElementById("minPrice");
const maxPriceInput = document.getElementById("maxPrice");
const sortOrderSelect = document.getElementById("sortOrder");

filterToggle.addEventListener("click", () => {
  if (filterOverlay.classList.contains("show")) {
    // If already open, close it
    filterOverlay.classList.remove("show");
    setTimeout(() => filterOverlay.style.display = "none", 300);
  } else {
    // If closed, open it
    filterOverlay.style.display = "block";
    setTimeout(() => filterOverlay.classList.add("show"), 10);
  }
});


filterClose.addEventListener("click", () => {
  filterOverlay.classList.remove("show");
  setTimeout(() => filterOverlay.style.display = "none", 300);
});

filterOverlay.addEventListener("click", e => {
  if(e.target === filterOverlay) {
    filterOverlay.classList.remove("show");
    setTimeout(() => filterOverlay.style.display = "none", 300);
  }
});

applyFilterBtn.addEventListener("click", () => {
  const min = parseFloat(minPriceInput.value) || 0;
  const max = parseFloat(maxPriceInput.value) || Infinity;
  const order = sortOrderSelect.value;

  let filteredProducts = Array.from(products).filter(p => {
    const price = parseFloat(p.querySelector(".price").innerText.replace("$",""));
    return price >= min && price <= max;
  });

  if(order === "asc") {
    filteredProducts.sort((a,b) => parseFloat(a.querySelector(".price").innerText.replace("$","")) - parseFloat(b.querySelector(".price").innerText.replace("$","")));
  } else if(order === "desc") {
    filteredProducts.sort((a,b) => parseFloat(b.querySelector(".price").innerText.replace("$","")) - parseFloat(a.querySelector(".price").innerText.replace("$","")));
  }

const productsContainer = document.querySelector(".products");

// Clear container first
productsContainer.innerHTML = "";

// Append filtered and sorted products
filteredProducts.forEach(p => productsContainer.appendChild(p));

  // Close overlay
  filterOverlay.classList.remove("show");
  setTimeout(() => filterOverlay.style.display = "none", 300);
});

/* ============================== 
   💳 Checkout Section
================================= */
checkoutBtn.addEventListener("click", () => {
  const activeDelivery = document.querySelector(".delivery-btn.active");
  const deliveryType = activeDelivery.innerText.trim();

  const locationInput = document.getElementById("userLocation").value.trim();
  if (deliveryType.includes("توصيل") && !locationInput) {
    alert("يرجى إدخال موقع منزلكم قبل الدفع.");
    return;
  }

  if (cart.length === 0) {
    alert("سلتك فارغة!");
    return;
  }

  const phone = document.getElementById("userPhone")?.value.trim() || "لم يتم إدخال رقم";
  const now = new Date();

  // Example discount settings
  const discountCode = "SUMMER10";  // Example discount code
  const discountRate = 0.10;        // 10% discount

  let subtotalBeforeDiscount = 0;
  cart.forEach(item => {
    subtotalBeforeDiscount += item.price * item.qty;
  });

  const discountAmount = subtotalBeforeDiscount * discountRate;
  const subtotalAfterDiscount = subtotalBeforeDiscount - discountAmount;

  let receipt = `📄 فاتورة الطلب\n`;
  receipt += `🕒 الوقت: ${now.toLocaleString()}\n`;
  receipt += `📱 رقم الهاتف: ${phone}\n`;
  receipt += `🏠 الموقع: ${locationInput || 'لم يتم إدخال موقع'}\n`;
  receipt += `🚚 طريقة التوصيل: ${deliveryType}\n\n`;

  receipt += `🛍️ المنتجات:\n`;
  cart.forEach(item => {
    const itemTotal = item.price * item.qty;
    receipt += `• ${item.title} - ${item.price}$ × ${item.qty} = ${itemTotal}$\n`;
  });

  receipt += `\nالمجموع الفرعي (قبل الخصم): ${subtotalBeforeDiscount.toFixed(2)}$\n`;
  receipt += `كود الخصم: ${discountCode}\n`;
  receipt += `الخصم: ${discountAmount.toFixed(2)}$\n`;
  receipt += `المجموع الفرعي (بعد الخصم): ${subtotalAfterDiscount.toFixed(2)}$\n`;
  receipt += `رسوم التوصيل: ${selectedDeliveryFee}$\n`;
  receipt += `الإجمالي: ${(subtotalAfterDiscount + selectedDeliveryFee).toFixed(2)}$`;

  const encodedReceipt = encodeURIComponent(receipt);
  window.open(`https://wa.me/9647881552046?text=${encodedReceipt}`, "_blank");
});

/* ==============================
   🍞 Toast Function
================================= */
function showToast(msg) {
  const toast = document.getElementById("toast");
  toast.innerText = msg;
  toast.style.visibility = "visible";
  toast.style.opacity = "1";
  setTimeout(() => {
    toast.style.opacity = "0";
    setTimeout(() => toast.style.visibility = "hidden", 500);
  }, 2000);
}

/* ==============================
   🚀 Init
================================= */
updateCart();
</script>
</body>
</html>
